# 46 | 缓存系统：如何通过哈希表和队列实现高效访问？

离散数学是基础数据结构和编程算法的基石，而概率统计论和线性代数，是很多信息检索和机器学习算法的核心。

## 缓存系统

缓存可以看作是一个高速缓冲区，当数据请求时，先查询缓存是否命中快速获取返回，如果没有再去查询缓慢的持久化存储然后返回数据，然后写入缓存。

设计缓存的几个考量：

1. 硬件性能。对 Web 服务来说通常是服务器内存。
2. 命中率。请求时命中缓存的概率，直接关系到缓存的性能。因为内存通常不会很大，所以我们要节约着用，没法缓存所有数据，我们就需要有缓存的淘汰算法，所以就存在命中率。
3. 更新周期。多久更新一次？关系到命中率和数据实时性。

### 设计缓存系统

缓存淘汰算法通常有 LFU（Least Frequently Used）策略和 LRU（least Recently Used）策略。LFU 会记录每个缓存对象被使用的频率，并将使用次数最少的对象剔除。LRU 会记录每个缓存对象最近使用的时间，并将使用时间点最久远的对象给剔除。

下面用哈希表和队列，来设计一个 LRU 策略的缓存：

哈希表的时间复杂度为 O(1) 所以可以用来做数据存储。是首先我们先根据空间等，分配一块数组空间，之后我们设计一个哈希函数，可以将数据按照哈希函数均匀分散在数组中，每一个数组的 item 是一个链表，因为可能会有哈希冲突，所以冲突的也要跟在后面。

LRU 策略使用时间最久远的对象会被淘汰，我们就可以使用队列来实现。队列是先进先出的结构，每次调用，我们将其放在在队列最尾部，即可通过队列存储使用时间。

使用过程如下，查询一条数据，先查询队列：

- 存在。表示缓存已经有了，从队列中拿出并放入队尾，同时计算哈希然后找到对应数据。
- 不存在。表示缓存没有，加入队列队尾，同时从其他系统获取数据并存储到哈希表。如果队列已满，则删除队头的数据。

还可以直接用数据的引用做队列，这样获取到队列就可以直接获取到数据，而无需再次查找或者做哈希运算，但是会稍微复杂一些。
